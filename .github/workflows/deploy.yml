name: Build and Deploy Documentation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Quick validation - runs first to fail fast
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Lean
        uses: leanprover/lean-action@v1
        with:
          auto-build: false

      - name: Get Lean build cache
        run: lake exe cache get

      - name: Build Lean project (fail fast)
        run: lake build

  # Fast build - just landing page and GIFs
  build-landing:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy static landing page
        run: |
          mkdir -p _site
          cp index.html _site/
          echo "Static landing page copied successfully"

      - name: Copy visualization videos
        run: |
          if [ -d "chebyshev_videos" ]; then
            cp -r chebyshev_videos _site/
            echo "Visualization videos copied successfully"
          else
            echo "ERROR: Chebyshev videos directory not found"
            exit 1
          fi

      - name: Copy paper PDF
        run: |
          mkdir -p _site/paper
          if [ -f "paper/chebyshev_circles.pdf" ]; then
            cp paper/chebyshev_circles.pdf _site/paper/
            echo "Paper PDF copied successfully"
          else
            echo "WARNING: Paper PDF not found at paper/chebyshev_circles.pdf"
          fi

      - name: List landing page contents
        run: |
          echo "=== Landing page deployment structure ==="
          find _site -type f

      - name: Upload landing page artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          name: 'github-pages-landing'

  # Deploy landing page (only for quick workflow on manual trigger with build_mode='quick')
  deploy-landing:
    if: github.event_name == 'workflow_dispatch' && inputs.build_mode == 'quick'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-landing
    steps:
      - name: Deploy landing page to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: 'github-pages-landing'

  # Full build - everything including docs and blueprint
  # Runs on every push to main, or manual workflow_dispatch with build_mode='full'
  build-full:
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.build_mode == 'full')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Lean
        uses: leanprover/lean-action@v1
        with:
          auto-build: false

      - name: Get Lean build cache
        run: lake exe cache get || true

      - name: Build Lean project
        run: lake build

      # Build API Documentation
      - name: Build API documentation
        run: |
          # Build documentation using the correct command
          lake build ChebyshevCircles:docs
          # doc-gen4 outputs to .lake/build/doc
          mkdir -p _site/docs
          if [ -d ".lake/build/doc" ]; then
            cp -r .lake/build/doc/* _site/docs/
            echo "API documentation built successfully"
          else
            echo "ERROR: API documentation not found after build"
            exit 1
          fi

      # Build Blueprint
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz libgraphviz-dev \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-xetex \
            latexmk

      - name: Install Python dependencies
        run: pip install -r blueprint/requirements.txt

      - name: Patch plastexdepgraph for hashable nodes
        run: python3 .github/scripts/patch_plastexdepgraph.py

      - name: Build blueprint (web)
        run: |
          cd blueprint
          leanblueprint web
          echo "=== Blueprint web build output ==="
          ls -la src/web/ || echo "WARNING: web directory not found"
          find src/web -type f | head -20 || true

      - name: Build blueprint (pdf)
        continue-on-error: true
        run: |
          cd blueprint
          leanblueprint pdf || echo "PDF generation failed, continuing with web version only"
          echo "=== Blueprint PDF build output ==="
          ls -la print/ || echo "WARNING: print directory not found"
          if [ -f "print/print.pdf" ]; then
            echo "PDF successfully generated: $(ls -lh print/print.pdf)"
          else
            echo "PDF not generated"
          fi

      - name: Check declarations
        continue-on-error: true
        run: |
          cd blueprint
          leanblueprint checkdecls || echo "Some declarations could not be verified"

      - name: Fix dependency graph for browser back/forward cache
        run: |
          python3 .github/scripts/fix_dep_graph_bfcache.py blueprint/web/dep_graph_document.html
          echo "Dependency graph patched for bfcache handling"

      - name: Copy blueprint to deployment directory
        run: |
          mkdir -p _site/blueprint
          if [ -d "blueprint/web" ] && [ "$(ls -A blueprint/web)" ]; then
            cp -r blueprint/web/* _site/blueprint/
            echo "Blueprint web files copied successfully"
          else
            echo "ERROR: Blueprint web build not found or empty"
            exit 1
          fi

      - name: Create dependency graph redirect page
        run: |
          # Create redirect page to blueprint's interactive dependency graph
          bash .github/scripts/create_graph_page.sh _site/graph
          echo "Dependency graph redirect page created (points to /blueprint/dep_graph_document.html)"

      - name: Copy static landing page
        run: |
          cp index.html _site/
          echo "Static landing page copied to full deployment"

      - name: Copy visualization videos
        run: |
          if [ -d "chebyshev_videos" ]; then
            cp -r chebyshev_videos _site/
            echo "Visualization videos copied successfully"
          else
            echo "WARNING: Chebyshev videos directory not found"
          fi

      - name: Copy paper PDF
        run: |
          mkdir -p _site/paper
          if [ -f "paper/chebyshev_circles.pdf" ]; then
            cp paper/chebyshev_circles.pdf _site/paper/
            echo "Paper PDF copied successfully"
          else
            echo "WARNING: Paper PDF not found at paper/chebyshev_circles.pdf"
          fi

      - name: List full deployment contents
        run: |
          echo "=== Full deployment structure ==="
          find _site -type f | head -50

      - name: Upload full site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          name: 'github-pages-full'

  # Deploy full site
  deploy-full:
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.build_mode == 'full')
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-full
    steps:
      - name: Deploy full site to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: 'github-pages-full'

name: Build and Deploy Documentation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Fast build - just landing page and GIFs
  build-landing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy static landing page
        run: |
          mkdir -p _site
          cp index.html _site/
          echo "Static landing page copied successfully"

      - name: Copy visualization GIFs
        run: |
          if [ -d "chebyshev_gifs" ]; then
            cp -r chebyshev_gifs _site/
            echo "Visualization GIFs copied successfully"
          else
            echo "ERROR: Chebyshev GIFs directory not found"
            exit 1
          fi

      - name: List landing page contents
        run: |
          echo "=== Landing page deployment structure ==="
          find _site -type f

      - name: Upload landing page artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          name: 'github-pages-landing'

  # Deploy landing page immediately
  deploy-landing:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-landing
    steps:
      - name: Deploy landing page to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: 'github-pages-landing'

  # Full build - everything including docs and blueprint
  build-full:
    runs-on: ubuntu-latest
    needs: deploy-landing
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Lean
        uses: leanprover/lean-action@v1
        with:
          auto-build: false

      - name: Get Lean build cache
        run: lake exe cache get || true

      - name: Build Lean project
        run: lake build

      # Build API Documentation
      - name: Build API documentation
        run: |
          # Build documentation using the correct command
          lake build ChebyshevCircles:docs
          # doc-gen4 outputs to .lake/build/doc
          mkdir -p _site/docs
          if [ -d ".lake/build/doc" ]; then
            cp -r .lake/build/doc/* _site/docs/
            echo "API documentation built successfully"
          else
            echo "ERROR: API documentation not found after build"
            exit 1
          fi

      # Build Blueprint
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz libgraphviz-dev \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-xetex \
            latexmk

      - name: Install Python dependencies
        run: pip install leanblueprint

      - name: Build blueprint (web)
        run: |
          cd blueprint
          leanblueprint web
          echo "=== Blueprint web build output ==="
          ls -la src/web/ || echo "WARNING: web directory not found"
          find src/web -type f | head -20 || true

      - name: Build blueprint (pdf)
        continue-on-error: true
        run: |
          cd blueprint
          leanblueprint pdf || echo "PDF generation failed, continuing with web version only"
          echo "=== Blueprint PDF build output ==="
          ls -la print/ || echo "WARNING: print directory not found"
          if [ -f "print/print.pdf" ]; then
            echo "PDF successfully generated: $(ls -lh print/print.pdf)"
          else
            echo "PDF not generated"
          fi

      - name: Check declarations
        continue-on-error: true
        run: |
          cd blueprint
          leanblueprint checkdecls || echo "Some declarations could not be verified"

      - name: Copy blueprint to deployment directory
        run: |
          mkdir -p _site/blueprint
          if [ -d "blueprint/src/web" ] && [ "$(ls -A blueprint/src/web)" ]; then
            cp -r blueprint/src/web/* _site/blueprint/
            echo "Blueprint web files copied successfully"
          else
            echo "ERROR: Blueprint web build not found or empty"
            exit 1
          fi

      - name: Create dependency graph page
        run: |
          mkdir -p _site/graph
          # Copy PDF to graph directory if it exists, then create page
          if [ -f "blueprint/print/print.pdf" ]; then
            cp blueprint/print/print.pdf _site/graph/blueprint.pdf
            echo "Blueprint PDF copied to graph directory"
            bash .github/scripts/create_graph_page.sh _site/graph blueprint.pdf
          else
            echo "WARNING: Blueprint PDF not found, creating placeholder graph page"
            bash .github/scripts/create_graph_page.sh _site/graph
          fi

      - name: Copy static landing page
        run: |
          cp index.html _site/
          echo "Static landing page copied to full deployment"

      - name: Copy visualization GIFs
        run: |
          if [ -d "chebyshev_gifs" ]; then
            cp -r chebyshev_gifs _site/
            echo "Visualization GIFs copied successfully"
          else
            echo "WARNING: Chebyshev GIFs directory not found"
          fi

      - name: List full deployment contents
        run: |
          echo "=== Full deployment structure ==="
          find _site -type f | head -50

      - name: Upload full site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          name: 'github-pages-full'

  # Deploy full site
  deploy-full:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-full
    steps:
      - name: Deploy full site to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: 'github-pages-full'
